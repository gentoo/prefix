#!/usr/bin/env bash
# Copyright Gentoo Foundation 2006-2007

if [ "${1:0:1}" = '=' ] || [ "${1:0:1}" = '<' ] || [ "${1:0:1}" = '>' ]; then
	ebuildgrep=${1#*\/}
	#catpkg=${1%-*}
	catpkg=${1#<}
	catpkg=${catpkg#>}
	catpkg=${catpkg#=}
else
	catpkg=$1
fi
mkdir -p $catpkg
cd $catpkg

wget http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/ChangeLog
wget http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/metadata.xml
wget http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/Manifest
if [ "${1:0:1}" = '=' ]; then
	ebuild=${2:-$(grep "+${ebuildgrep%\*}[^ ]*.ebuild" ChangeLog | head -n 1 | sed -e "s:.*+::" -e "s/://")}
else
	ebuild=${2:-$(grep "+[^ ]*.ebuild" ChangeLog | head -n 1 | sed -e "s:.*+::" -e "s/://")}
fi

PF=${ebuild/.ebuild}
P=${PF%-r[1-9]*}
PN=${P%-*}
PV=${P/${PN}-}

wget http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/$ebuild
mkdir files
wget -P files http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/files/digest-${PF}

source $ebuild
for i in $(eval echo $(grep FILESDIR $ebuild | sed -e 's:.*FILESDIR[}"]*/::' -e 's:"::g' -e "s:'::" -e "s:#.*::" -e "s: .*::")); do
	wget -P files http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/files/$i
done
eapify $ebuild
ecleankw $ebuild
source "${EPREFIX:-$(portageq envvar EPREFIX)}"/etc/make.profile/make.defaults
ekeyword ~$ACCEPT_KEYWORDS $ebuild
ebuild $ebuild digest
