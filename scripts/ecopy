#!/usr/bin/env bash
# Copyright Gentoo Foundation 2006-2008

if [[ -z ${1} ]] ; then
	cat <<-EOF
usage: ecopy <category>/<package>
  - make sure the scripts directory from the overlay is in your path
  - make sure you call ecopy from the root of the overlay
  - you can also specify a specific version, using the '=' prefix
    and appending a version
EOF
	exit 0
fi

if [[ *${1:0:1}* == "=" ]] ; then
	ebuildgrep=${1#*\/}
	#catpkg=${1%-*}
	catpkg=${1#=}
else
	catpkg=$1
fi
mkdir -p $catpkg
cd $catpkg

wget --no-glob "http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/ChangeLog"
wget --no-glob "http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/metadata.xml"
wget --no-glob "http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/Manifest"

if [[ ${1:0:1} == "=" ]] ; then
	ebuild=$(grep "+${ebuildgrep%\*}[^ ]*.ebuild" ChangeLog | head -n 1 | sed -e "s:.*+::" -e "s/://")
else
	ebuild=$(grep "+[^ ]*.ebuild" ChangeLog | head -n 1 | sed -e "s:.*+::" -e "s/://")
fi

if [[ -z "$ebuild" ]] ; then
	echo "please specify a correct specific version"
	[[ ${1:0:1} == "=" ]] \
		&& echo "$1 doesn't match an existing ebuild" \
		|| echo "example: =$1-0.2.3"
	exit -1
fi

PF=${ebuild/.ebuild}
P=${PF%-r[1-9]*}
PN=${P%-*}
PV=${P/${PN}-}

wget --no-glob "http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/$ebuild"

source $ebuild
for i in $(eval echo $(grep FILESDIR $ebuild | sed -e 's:.*FILESDIR[}"]*/::' -e 's:"::g' -e "s:'::" -e "s:#.*::" -e "s: .*::")); do
	mkdir -p files
	wget --no-glob -P files "http://sources.gentoo.org/viewcvs.py/*checkout*/gentoo-x86/$catpkg/files/$i"
done
eapify $ebuild
ecleankw $ebuild
source "${EPREFIX:-$(portageq envvar EPREFIX)}"/etc/make.profile/make.defaults
ekeyword "~${ACCEPT_KEYWORDS#\~}" $ebuild
ebuild $ebuild digest
